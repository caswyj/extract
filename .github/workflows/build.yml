name: Build SnapOCR

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2.0.0)'
        required: false
        default: ''

permissions:
  contents: write

env:
  TESSERACT_VERSION: '5.3.3'

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download Tesseract for macOS
        run: |
          brew install tesseract tesseract-lang

          mkdir -p tesseract tessdata lib

          cp $(which tesseract) tesseract/

          brew deps tesseract | while read dep; do
            if [ -d "/opt/homebrew/opt/$dep/lib" ]; then
              cp /opt/homebrew/opt/$dep/lib/*.dylib lib/ 2>/dev/null || true
            fi
          done

          cp /opt/homebrew/share/tessdata/eng.traineddata tessdata/
          cp /opt/homebrew/share/tessdata/chi_sim.traineddata tessdata/ 2>/dev/null || \
            curl -L -o tessdata/chi_sim.traineddata https://github.com/tesseract-ocr/tessdata/raw/main/chi_sim.traineddata

      - name: Build macOS app
        run: |
          python -m PyInstaller \
            --name "SnapOCR" \
            --windowed \
            --onedir \
            --hidden-import "PIL._tkinter_finder" \
            --hidden-import "pytesseract" \
            --hidden-import "mss" \
            --hidden-import "snapocr" \
            --hidden-import "snapocr.main" \
            --hidden-import "snapocr.core.config" \
            --hidden-import "snapocr.core.ocr" \
            --hidden-import "snapocr.core.clipboard" \
            --hidden-import "snapocr.platform.base" \
            --hidden-import "snapocr.platform.macos" \
            --hidden-import "snapocr.platform.macos_native" \
            --hidden-import "snapocr.ui" \
            --hidden-import "snapocr.ui.selection_overlay" \
            --hidden-import "snapocr.ui.result_panel" \
            --hidden-import "snapocr.ui.button_bar" \
            --hidden-import "snapocr.ui.pinned_window" \
            --hidden-import "rapid_latex_ocr" \
            --add-data "snapocr:snapocr" \
            --add-data "tesseract:tesseract" \
            --add-data "tessdata:tessdata" \
            --add-binary "lib:lib" \
            --osx-bundle-identifier "com.snapocr.app" \
            --target-arch arm64 \
            run.py

          cp resources/Info.plist dist/SnapOCR.app/Contents/Info.plist

      - name: Codesign app (ad-hoc)
        run: codesign --deep --force --sign - dist/SnapOCR.app

      - name: Create ZIP archive
        run: cd dist && zip -r SnapOCR-macOS-arm64.zip SnapOCR.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SnapOCR-macOS
          path: dist/SnapOCR-macOS-arm64.zip

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download Tesseract for Windows
        run: |
          Invoke-WebRequest -Uri "https://digi.bib.uni-mannheim.de/tesseract/tesseract-ocr-w64-setup-${env:TESSERACT_VERSION}.20231005.exe" -OutFile "tesseract-setup.exe"
          7z x tesseract-setup.exe -o"tesseract_extract" -y

          New-Item -ItemType Directory -Force -Path "tesseract"
          New-Item -ItemType Directory -Force -Path "tessdata"

          Copy-Item "tesseract_extract/tesseract.exe" "tesseract/" -ErrorAction SilentlyContinue
          Copy-Item "tesseract_extract/*.dll" "tesseract/" -ErrorAction SilentlyContinue

          if (Test-Path "C:\Program Files\Tesseract-OCR") {
            Copy-Item "C:\Program Files\Tesseract-OCR\tesseract.exe" "tesseract/"
            Copy-Item "C:\Program Files\Tesseract-OCR\*.dll" "tesseract/"
            Copy-Item "C:\Program Files\Tesseract-OCR\tessdata\eng.traineddata" "tessdata/"
            Copy-Item "C:\Program Files\Tesseract-OCR\tessdata\chi_sim.traineddata" "tessdata/" -ErrorAction SilentlyContinue
          }

          if (-not (Test-Path "tessdata/chi_sim.traineddata")) {
            Invoke-WebRequest -Uri "https://github.com/tesseract-ocr/tessdata/raw/main/chi_sim.traineddata" -OutFile "tessdata/chi_sim.traineddata"
          }
        env:
          TESSERACT_VERSION: '5.3.3'

      - name: Build Windows executable
        run: |
          pyinstaller `
            --name "SnapOCR" `
            --onefile `
            --windowed `
            --hidden-import "PIL._tkinter_finder" `
            --hidden-import "pytesseract" `
            --hidden-import "mss" `
            --hidden-import "snapocr" `
            --hidden-import "snapocr.main" `
            --hidden-import "snapocr.core.config" `
            --hidden-import "snapocr.core.ocr" `
            --hidden-import "snapocr.core.clipboard" `
            --hidden-import "snapocr.platform.base" `
            --hidden-import "snapocr.platform.windows" `
            --hidden-import "snapocr.ui" `
            --hidden-import "snapocr.ui.selection_overlay" `
            --hidden-import "snapocr.ui.result_panel" `
            --hidden-import "snapocr.ui.button_bar" `
            --hidden-import "snapocr.ui.pinned_window" `
            --hidden-import "rapid_latex_ocr" `
            --add-data "snapocr;snapocr" `
            --add-data "tesseract;tesseract" `
            --add-data "tessdata;tessdata" `
            run.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SnapOCR-Windows
          path: dist/SnapOCR.exe

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk scrot tesseract-ocr tesseract-ocr-eng tesseract-ocr-chi-sim

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Prepare Tesseract bundle
        run: |
          mkdir -p tesseract tessdata lib

          cp $(which tesseract) tesseract/
          cp /usr/share/tesseract-ocr/*/tessdata/eng.traineddata tessdata/
          cp /usr/share/tesseract-ocr/*/tessdata/chi_sim.traineddata tessdata/

          ldd $(which tesseract) | grep "=> /" | awk '{print $3}' | while read lib; do
            cp "$lib" lib/ 2>/dev/null || true
          done

      - name: Build Linux executable
        run: |
          python -m PyInstaller \
            --name "SnapOCR" \
            --onefile \
            --hidden-import "PIL._tkinter_finder" \
            --hidden-import "pytesseract" \
            --hidden-import "mss" \
            --hidden-import "snapocr" \
            --hidden-import "snapocr.main" \
            --hidden-import "snapocr.core.config" \
            --hidden-import "snapocr.core.ocr" \
            --hidden-import "snapocr.core.clipboard" \
            --hidden-import "snapocr.platform.base" \
            --hidden-import "snapocr.platform.linux" \
            --hidden-import "snapocr.ui" \
            --hidden-import "snapocr.ui.selection_overlay" \
            --hidden-import "snapocr.ui.result_panel" \
            --hidden-import "snapocr.ui.button_bar" \
            --hidden-import "snapocr.ui.pinned_window" \
            --hidden-import "rapid_latex_ocr" \
            --add-data "snapocr:snapocr" \
            --add-data "tesseract:tesseract" \
            --add-data "tessdata:tessdata" \
            --add-binary "lib:lib" \
            run.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SnapOCR-Linux
          path: dist/SnapOCR

  release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.version != ''
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: SnapOCR-macOS
          path: artifacts/

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: SnapOCR-Windows
          path: artifacts/

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: SnapOCR-Linux
          path: artifacts/

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: SnapOCR ${{ steps.version.outputs.version }}
          body: |
            ## SnapOCR ${{ steps.version.outputs.version }}

            ### Downloads
            - **macOS**: `SnapOCR-macOS-arm64.zip` (Apple Silicon)
            - **Windows**: `SnapOCR.exe`
            - **Linux**: `SnapOCR`

            ### Features
            - **Interactive UI Mode**: Use `--ui` flag for Pin/Accept/Cancel buttons
              - Pin: Create floating window with screenshot
              - Accept: Copy OCR text to clipboard
              - Cancel: Close without action
            - **Region Selection**: Full-screen dimmed overlay with highlighted selection
            - Tesseract OCR bundled - no external installation required
            - RapidLatexOCR for math formula recognition
            - Supports English and Chinese (Simplified) OCR
            - Copy recognized text to clipboard with one click

            ### Usage
            ```bash
            # Basic mode (copy to clipboard directly)
            ./SnapOCR

            # Interactive UI mode
            ./SnapOCR --ui

            # With LaTeX math formula support
            ./SnapOCR --ui --latex
            ```

            ### System Requirements
            - **macOS**: macOS 11.0+ (Apple Silicon)
            - **Windows**: Windows 10/11 (64-bit)
            - **Linux**: glibc 2.31+ (Ubuntu 20.04+)
          files: |
            artifacts/SnapOCR-macOS-arm64.zip
            artifacts/SnapOCR.exe
            artifacts/SnapOCR
          draft: false
          prerelease: false
